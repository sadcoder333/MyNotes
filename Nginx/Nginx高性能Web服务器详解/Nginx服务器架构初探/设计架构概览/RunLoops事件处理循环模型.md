# Run Loops事件处理循环模型

>Run Loops，指的是进程内部用来不停地调配工作，对事件进行循环处理的一种模型。它属于进程或者线程的基础架构部分。该模型对事件的处理不是自动的，需要在设计代码过程中，在适当的时候启动Run-Loop机制对输入的事件作出响应。

该模型是一个集合，集合中的每一个元素称为一个Run-Loop。每个Run-Loop可运行在不同的模式下，其中可以包含它所监听的输入事件源、定时器以及在事件发生时需要通知的Run-Loop监听器（Run-Loop Observers）。为了监听特定的事件，可以在Run Loops中添加相应的Run-Loop监听器。当被监听的事件发生时，Run-Loop会产生一个消息，被Run-Loop监听器捕获，从而执行预定的动作。

Nginx服务器在工作进程中实现了Run-Loop事件处理循环模型的使用，用来处理客户端发来的请求事件。该部分的实现可以说是Nginx服务器程序实现中最为复杂的部分，包含了对输入事件繁杂的响应和处理过程，并且这些处理过程都是基于异步任务处理的。

我们不打算在这一章深入介绍Nginx服务器的Run-Loop模型。这部分的实现过程结合相关代码实现会更容易理解，因此我们在探讨Nginx服务器源码实现时再对它进行详细介绍，这里大家知道Run-Loop模型的作用就可以了。

通过学习Nginx服务器的整体架构，我们对Nginx服务器各个模块的作用和联系有了比较清晰的认识。可以看到，Nginx服务器提供了异步的、非阻塞的Web服务，系统中的模块各司其职，彼此之间通常使用网络、管道和信号等机制进行通信，从而保持了松耦合的关系。工作进程中事件处理机制的使用，在很大程度上降低了在网络负载繁重的情况下Nginx服务器对内存、磁盘的压力，同时保证了对客户端请求的及时响应。

>这里需要提及的一点是，笔者在实际使用Nginx服务器的过程中发现，当磁盘没有足够的性能处理大量IO调用时，工作进程仍然可能因为磁盘读写调用而阻塞，进而导致客户端请求超时失败等问题。目前可以通过多种方法来降低对磁盘IO的调用，比如引入异步输入/输出（Asynchronous Input/Output，AIO）机制等，但这些处理办法没有从根本上解决问题。为了尽量避免产生这种问题，大家在实际部署Nginx服务器时，应当对其运行环境有一个基本的了解，针对不同的网络负载环境选择相匹配的硬件环境，并对Nginx服务器进行合理的配置。